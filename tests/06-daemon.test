#!/usr/bin/env bash

source "$TEST_DIR/lib"

start(){
	./chronosd daemon "$DIR" &
	PID=$!
	_assert [ $PID -ne 0 ]
	SECONDS=0
	START_TIME=0
	if [ ! -p "$DIR/fifo" ]; then
		# give chronosd a moment to start up
		sleep 0.01
	fi
	_assert [ -p "$DIR/fifo" ]
	_assert [ -f "$DIR/pid" ]
	local pid=`cat "$DIR/pid" `
	_assort [ "$PID" = "$pid" ]
}

killd(){
	kill -SIGTERM $PID
	_assert [ ! -p "$DIR/fifo" ]
	# in case it doesn't actually manage it,
	# because otherwise tup has serious problems
	if [ -p "$DIR/fifo" ]; then
		rm "$DIR/fifo"
	fi
	PID=0
}

stop(){
	./chronosd stop "$DIR"
	_assert [ ! -p "$DIR/fifo" ]
	_assert [ ! -f "$DIR/pid" ]
	# in case it doesn't actually manage it,
	# because otherwise tup has serious problems
	if [ -p "$DIR/fifo" ]; then
		rm "$DIR/fifo"
	fi
	PID=0
}

append(){
	echo 123 | _assert ./chronosd append "$DIR"
}

_assert_variable TEST_DIR
DIR="$TEST_DIR/init.d"

_assert ./chronos init "$DIR"

# check start
start
killd

# check stop
start
stop

# check append
start
append
stop

# shouldn't work without daemon
echo abc | _assert_not ./chronosd append "$DIR"

# check chronos read, if this doesn't work, it will deadlock. heh
start
append
_assert ./chronos list "$DIR"
stop

rm -r "$DIR"
